================================================================================
             SƠ ĐỒ HỆ THỐNG XEM PHIM & TÌM KIẾM THÔNG MINH ELASTICSEARCH
                              (PHIÊN BẢN HOÀN CHỈNH)
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                            KIẾN TRÚC TỔNG THỐNG                            │
└────────────────────────────────────────────────────────────────────────────┘

                                    ▼
    ┌───────────────────────────────────────────────────────────────────┐
    │                            NGƯỜI DÙNG                            │
    │                              USER                                │
    └───────────────┬─────────────────────────────────────┬─────────────┘
                    │                                     │
      Nhập từ khóa tìm kiếm                      Chọn một bộ phim
                    │                                     │
                    ▼                                     ▼
    ┌───────────────────────────────────────┐    ┌─────────────────────┐
    │            FRONTEND UI                │    │      FRONTEND       │
    │      (Giao diện tìm kiếm)             │    │   (Xem chi tiết)    │
    └───────────────┬───────────────────────┘    └──────────┬──────────┘
                    │                                       │
        Gửi request /api/search?q=                  Gửi api/movies/slug
                    │                                       │
                    ▼                                       ▼
    ┌───────────────────────────────────────┐    ┌─────────────────────┐
    │            API GATEWAY                │    │     API GATEWAY     │
    │          (Search Route)               │    │    (Movie Route)    │
    └───────────────┬───────────────────────┘    └──────────┬──────────┘
                    │                                       │
            Định tuyến đến                           Định tuyến đến
          Search Controller                        Movie Controller
                    │                                       │
                    ▼                                       ▼
    ┌───────────────────────────────────────┐    ┌─────────────────────┐
    │         SEARCH CONTROLLER             │    │   MOVIE CONTROLLER  │
    │         (Phân tích từ khóa)           │    │  (Lấy chi tiết)     │
    └───────────────┬───────────────────────┘    └──────────┬──────────┘
                    │                                       │
             Gọi Search Service                       Truy vấn dữ liệu
                    │                                       │
                    ▼                                       ▼
    ┌───────────────────────────────────────┐    ┌─────────────────────┐
    │       ELASTICSEARCH SERVICE           │    │    MONGODB (MAIN)   │
    │     (Thực hiện truy vấn và tìm        │    │   (Lưu trữ chính)   │
    │           dữ liệu trong chỉ mục)      │    │                     │
    └───────────────┬───────────────────────┘    └──────────┬──────────┘
                    │                                       │
                    │                              Trả về chi tiết phim
        Truy vấn Elasticsearch                             │
                    │                                       │
                    ▼                                       │
    ┌───────────────────────────────────────┐              │
    │           ELASTICSEARCH               │              │
    │           (Search Index)              │              │
    └───────────────┬───────────────────────┘              │
                    │                                       │
         Trả kết quả tìm kiếm                              │
                    │                                       │
                    │                                       │
                    │    ┌─────────────────────────────────┘
                    │    │
                    │    │    Nếu Elasticsearch lỗi
                    │    │    ┌───────────────────────────────┐
                    │    │    │     MONGODB FALLBACK         │
                    │    │    │     (Tìm kiếm truyền thống)  │
                    │    │    └──────────────┬────────────────┘
                    │    │                   │
                    │    │       Truy vấn MongoDB trực tiếp
                    │    │                   │
                    │    ▼                   ▼
                    │    ┌───────────────────────────────┐
                    └────►      RESPONSE FORMAT          │
                         │      (Định dạng kết quả)      │
                         └──────────────┬────────────────┘
                                        │
                     Trả JSON về API Gateway
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │                          FRONTEND RENDERING                         │
    │                     (Hiển thị kết quả cho người dùng)              │
    └─────────────────────────────────────────────────────────────────────┘

================================================================================
                      LUỒNG TÌM KIẾM CHI TIẾT (SEQUENCE)
================================================================================

    NGƯỜI DÙNG            FRONTEND UI           API GATEWAY         SEARCH CONTROLLER
        │                      │                     │                      │
        │ 1. Nhập từ khóa      │                     │                      │
        │ ───────────────────► │                     │                      │
        │                      │ 2. GET /api/search  │                      │
        │                      │ ───────────────────►│                      │
        │                      │                     │ 3. handleSearch()    │
        │                      │                     │ ──────────────────► │
        │                      │                     │                      │
        │                      │                     │                      │
                                                                            │
    ELASTICSEARCH SERVICE      ELASTICSEARCH      MONGODB FALLBACK          │
            │                       │                   │                   │
            │ 4. searchMovies()     │                   │                  │
            │◄──────────────────────────────────────────────────────────────
            │                       │                   │                   │
            │ 5. Execute Query      │                   │                   │
            │ ──────────────────► │                   │                   │
            │                       │                   │                   │
            │                       │ 6. Search Results │                   │
            │                       │ ◄─────────────── │                   │
            │ 7. Results            │                   │                   │
            │◄──────────────────────│                   │                   │
            │                       │                   │                   │
            │                 8. If Elasticsearch fails │                   │
            │ ──────────────────────────────────────────│                   │
            │                       │                   │                   │
            │                       │                   │ 9. MongoDB Search │
            │                       │                   │ ◄───────────────── │
            │                       │                   │                   │
            │                       │      MONGODB      │                   │
            │                       │        │         │                   │
            │                       │        │ 10. Results                 │
            │                       │        │ ───────► │                   │
            │                       │                   │                   │
            │                       │      11. MongoDB Results             │
            │◄──────────────────────────────────────────│                   │
            │                       │                   │                   │
            │ 12. Format Results    │                   │                   │
            │ ──────────────────► │                   │                   │
            │                       │                   │                   │
            │ 13. JSON Response     │                   │                   │
            │ ──────────────────────────────────────────────────────────────│
            │                       │                   │                   │
                                                                            │
    NGƯỜI DÙNG            FRONTEND UI           API GATEWAY         SEARCH CONTROLLER
        │                      │                     │                      │
        │                      │                     │ 14. Search Results   │
        │                      │                     │◄──────────────────── │
        │                      │ 15. Results JSON    │                      │
        │                      │◄────────────────────│                      │
        │ 16. Hiển thị kết quả │                     │                      │
        │◄─────────────────────│                     │                      │
        │                      │                     │                      │
        │ 17. Chọn một bộ phim │                     │                      │
        │ ───────────────────► │                     │                      │
        │                      │                     │                      │

================================================================================
                          LUỒNG XEM PHIM CHI TIẾT
================================================================================

    NGƯỜI DÙNG            FRONTEND UI           API GATEWAY         MOVIE CONTROLLER
        │                      │                     │                     │
        │ 1. Chọn phim        │                     │                     │
        │ ───────────────────►│                     │                     │
        │                      │                     │                     │
        │                      │ 2. GET /api/movies/:slug                │
        │                      │ ───────────────────►│                     │
        │                      │                     │ 3. getMovieById()   │
        │                      │                     │ ─────────────────► │
        │                      │                     │                     │
        │                      │                     │                     │
                                                                           │
    MONGODB                    │                     │                     │
       │                       │                     │                     │
       │ 4. Truy vấn phim     │                     │                     │
       │◄──────────────────────────────────────────────────────────────────
       │                       │                     │                     │
       │ 5. Trả dữ liệu phim  │                     │                     │
       │ ─────────────────────────────────────────────────────────────────►│
       │                       │                     │                     │
                                                                           │
    NGƯỜI DÙNG            FRONTEND UI           API GATEWAY         MOVIE CONTROLLER
        │                      │                     │                     │
        │                      │                     │ 6. Movie Details    │
        │                      │                     │◄─────────────────── │
        │                      │ 7. Details JSON     │                     │
        │                      │◄────────────────────│                     │
        │                      │                     │                     │
        │                      │                     │                     │

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        PHIM CÓ TỒN TẠI?                                │
    └──────────────┬─────────────────────────────────┬───────────────────────┘
                   │ CÓ                            │ KHÔNG
                   ▼                                ▼
    ┌──────────────────────────────┐     ┌────────────────────────────────────┐
    │   HIỂN THỊ THÔNG TIN PHIM    │     │          HIỂN THỊ LỖI 404         │
    └──────────────┬───────────────┘     └────────────────────────────────────┘
                   │
                   ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                            CÓ EPISODES?                                 │
    └──────────────┬─────────────────────────────────┬───────────────────────┘
                   │ CÓ                            │ KHÔNG
                   ▼                                ▼
    ┌──────────────────────────────┐     ┌────────────────────────────────────┐
    │   HIỂN THỊ VIDEO PLAYER      │     │         HIỂN THỊ TRAILER          │
    │   -------------------        │     └────────────────────────────────────┘
    │   • Chọn server              │
    │   • Chọn chất lượng         │
    │   • Điều khiển phát         │
    │   • Chế độ toàn màn hình    │
    └──────────────┬───────────────┘
                   │
                   ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                            USER ACTIONS                                 │
    ├─────────────────────────────────────────────────────────────────────────┤
    │ ┌─────────────┐ ┌────────────┐ ┌───────────┐ ┌───────────────────────┐ │
    │ │ Thêm vào    │ │ Xem sau    │ │ Đánh giá │ │ Bình luận            │ │
    │ │ yêu thích   │ │            │ │           │ │                       │ │
    │ └─────────────┘ └────────────┘ └───────────┘ └───────────────────────┘ │
    │ ┌─────────────┐ ┌────────────┐ ┌───────────┐ ┌───────────────────────┐ │
    │ │ Chia sẻ     │ │ Báo cáo    │ │ Phim      │ │ Đề xuất phim         │ │
    │ │             │ │ lỗi        │ │ liên quan │ │ tương tự             │ │
    │ └─────────────┘ └────────────┘ └───────────┘ └───────────────────────┘ │
    └─────────────────────────────────────────────────────────────────────────┘

================================================================================
                       KẾT NỐI GIỮA CÁC THÀNH PHẦN
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                            TỔNG THỂ HỆ THỐNG                              │
└────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐                          ┌──────────────────────────┐
    │                 │                          │                          │
    │    KẾT QUẢ      │◄─────┐              ┌────│      CHI TIẾT PHIM       │
    │   TÌM KIẾM     │      │              │    │                          │
    │                 │      │              │    └──────────────────────────┘
    └────────┬─────────┘      │              │                 ▲
             │                │              │                 │
             │                │              │                 │
             ▼                │              ▼                 │
    ┌──────────────────┐      │     ┌──────────────────────────┐
    │                 │      │     │                          │
    │   FRONTEND UI   │      └─────│     NEXT.JS FRONTEND     │
    │   TÌM KIẾM     │            │                          │
    │                 │            └──────────────────────────┘
    └────────┬─────────┘                       │
             │                                 │
             │                                 │
             ▼                                 ▼
    ┌──────────────────┐              ┌──────────────────────────┐
    │                 │              │                          │
    │   API GATEWAY   │              │       API GATEWAY        │
    │    SEARCH       │              │         MOVIE            │
    │                 │              │                          │
    └────────┬─────────┘              └──────────┬───────────────┘
             │                                  │
             │                                  │
             ▼                                  ▼
    ┌──────────────────┐              ┌──────────────────────────┐
    │                 │              │                          │
    │     SEARCH      │              │         MOVIE            │
    │   CONTROLLER    │              │       CONTROLLER         │
    │                 │              │                          │
    └────────┬─────────┘              └──────────┬───────────────┘
             │                                  │
             │                                  │
             ▼                                  │
    ┌──────────────────┐                       │
    │                 │                       │
    │  ELASTICSEARCH  │                       │
    │    SERVICE      │                       │
    │                 │                       │
    └────────┬─────────┘                       │
             │                                 │
             │                                 │
       ┌─────┴────────┐                        │
       │              │                        │
       ▼              ▼                        ▼
┌─────────────┐ ┌─────────────┐       ┌─────────────────┐
│             │ │             │       │                 │
│ELASTICSEARCH │ │  MONGODB   │◄──────┤    MONGODB      │
│Search Index │ │  FALLBACK   │       │  Main Database  │
│             │ │             │       │                 │
└─────────────┘ └─────────────┘       └─────────────────┘

================================================================================
                           LUỒNG DỮ LIỆU CHI TIẾT
================================================================================

LUỒNG DỮ LIỆU TÌM KIẾM:
------------------------

1. Người dùng nhập từ khóa vào Frontend UI
2. Frontend UI gửi request đến API Gateway (/api/search?q=...)
3. API Gateway định tuyến đến Search Controller
4. Search Controller phân tích từ khóa và gọi Elasticsearch Service
5. Elasticsearch Service xây dựng query phức tạp (fuzzy, multi-field...)
6. Truy vấn được gửi đến Elasticsearch 
7. Elasticsearch trả về kết quả tìm kiếm
8. NẾU Elasticsearch lỗi, chuyển sang MongoDB Fallback
   a. MongoDB Fallback thực hiện truy vấn regex trên MongoDB
   b. MongoDB trả kết quả cho Fallback Service
   c. Fallback Service trả kết quả cho Elasticsearch Service
9. Elasticsearch Service định dạng kết quả
10. Search Controller trả JSON về cho API Gateway
11. API Gateway trả kết quả về cho Frontend UI
12. Frontend UI hiển thị kết quả cho người dùng

LUỒNG DỮ LIỆU XEM PHIM:
-----------------------

1. Người dùng chọn một bộ phim từ kết quả tìm kiếm
2. Frontend gửi request đến API Gateway (/api/movies/:slug)
3. API Gateway định tuyến đến Movie Controller
4. Movie Controller truy vấn MongoDB để lấy chi tiết phim
5. MongoDB trả về dữ liệu phim đầy đủ
6. Movie Controller trả JSON về cho API Gateway
7. API Gateway trả kết quả về Frontend
8. Frontend kiểm tra phim có tồn tại không
   a. NẾU KHÔNG: Hiển thị lỗi 404
   b. NẾU CÓ: Hiển thị thông tin phim và kiểm tra episodes
9. Kiểm tra phim có episodes không
   a. NẾU KHÔNG: Hiển thị trailer
   b. NẾU CÓ: Hiển thị video player với các tùy chọn
10. Người dùng có thể thực hiện các hành động: thêm vào yêu thích, 
    xem sau, đánh giá, bình luận, chia sẻ, báo cáo lỗi

================================================================================
                         CÁC TÍNH NĂNG NÂNG CAO
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                            TÌM KIẾM THÔNG MINH                            │
└────────────────────────────────────────────────────────────────────────────┘

• MULTI-FIELD SEARCH: Tìm kiếm trên nhiều trường (tên, diễn viên, nội dung...)
• FUZZY MATCHING: Cho phép lỗi chính tả, từ gần đúng
• SEARCH SUGGESTION: Gợi ý từ khóa khi người dùng gõ
• BOOSTING: Ưu tiên kết quả tên phim hơn so với nội dung
• FILTERS: Lọc theo thể loại, năm, quốc gia, đánh giá...

┌────────────────────────────────────────────────────────────────────────────┐
│                            TỐI ƯU HIỆU SUẤT                               │
└────────────────────────────────────────────────────────────────────────────┘

• CACHING: Lưu cache kết quả tìm kiếm phổ biến
• QUERY OPTIMIZATION: Tối ưu cú pháp truy vấn Elasticsearch
• FALLBACK MECHANISM: Tự động chuyển sang MongoDB khi cần
• PAGINATION: Phân trang hiệu quả cho kết quả tìm kiếm
• BATCH PROCESSING: Xử lý dữ liệu theo lô khi cần thiết

┌────────────────────────────────────────────────────────────────────────────┐
│                        TRẢI NGHIỆM NGƯỜI DÙNG                             │
└────────────────────────────────────────────────────────────────────────────┘

• RESPONSIVE UI: Giao diện thích ứng mọi thiết bị
• REAL-TIME SEARCH: Tìm kiếm theo thời gian thực khi gõ
• SMART RECOMMENDATIONS: Đề xuất phim thông minh dựa trên lịch sử
• SEARCH HISTORY: Lưu lịch sử tìm kiếm của người dùng
• HIGHLIGHTED RESULTS: Highlight từ khóa trong kết quả tìm kiếm

================================================================================
                                API ENDPOINTS
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                             SEARCH ENDPOINTS                              │
└────────────────────────────────────────────────────────────────────────────┘

• GET /api/search
  - Query params: q, page, size, sort, filter
  - Mô tả: Tìm kiếm phim theo từ khóa và bộ lọc
  - Response: { total, page, results[], facets }

• GET /api/search/suggestions
  - Query params: q, limit
  - Mô tả: Gợi ý từ khóa khi người dùng đang gõ
  - Response: { suggestions[] }

• GET /api/search/history
  - Auth: Required
  - Mô tả: Lấy lịch sử tìm kiếm của người dùng
  - Response: { history[] }

┌────────────────────────────────────────────────────────────────────────────┐
│                             MOVIE ENDPOINTS                               │
└────────────────────────────────────────────────────────────────────────────┘

• GET /api/movies/:slug
  - Mô tả: Lấy thông tin chi tiết của phim
  - Response: { movie_details, episodes[], related[] }

• GET /api/movies/:slug/episodes
  - Query params: server (optional)
  - Mô tả: Lấy danh sách episodes của phim
  - Response: { episodes[] }

• GET /api/movies/:slug/related
  - Mô tả: Lấy phim liên quan
  - Response: { related_movies[] }

┌────────────────────────────────────────────────────────────────────────────┐
│                             ADMIN ENDPOINTS                               │
└────────────────────────────────────────────────────────────────────────────┘

• POST /api/admin/elasticsearch/reindex
  - Auth: Admin
  - Mô tả: Tái tạo chỉ mục Elasticsearch từ MongoDB
  - Body: { index, options }

• GET /api/admin/elasticsearch/status
  - Auth: Admin
  - Mô tả: Kiểm tra trạng thái của Elasticsearch
  - Response: { status, indices, stats }

• POST /api/admin/search/optimize
  - Auth: Admin
  - Mô tả: Tối ưu cấu hình tìm kiếm
  - Body: { settings }

================================================================================
                                  KẾT LUẬN
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                              LỢI ÍCH                                      │
└────────────────────────────────────────────────────────────────────────────┘

✓ TÌM KIẾM THÔNG MINH
  • Elasticsearch cung cấp khả năng tìm kiếm nhanh và chính xác
  • Hỗ trợ tìm kiếm mờ (fuzzy), đa ngôn ngữ và nhiều trường

✓ ĐỘ TIN CẬY CAO
  • Cơ chế fallback tự động chuyển sang MongoDB khi cần
  • Luôn đảm bảo người dùng nhận được kết quả tìm kiếm

✓ HIỆU SUẤT TỐI ƯU
  • Caching kết quả tìm kiếm phổ biến
  • Tối ưu query và indexing cho tốc độ cao

✓ TRẢI NGHIỆM NGƯỜI DÙNG
  • Giao diện thân thiện, responsive
  • Gợi ý tìm kiếm và hiển thị kết quả nhanh chóng

✓ KHẢ NĂNG MỞ RỘNG
  • Kiến trúc module dễ dàng bổ sung tính năng mới
  • Có thể mở rộng quy mô theo nhu cầu

================================================================================
